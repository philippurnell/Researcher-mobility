
-- ============================================
-- SECTION 1: SETUP & CONFIGURATION
-- ============================================
SET NOCOUNT ON;

-- Parameters (edit here to change time frame)
DECLARE @first_start_year INT = 2000;
DECLARE @first_end_year   INT = 2010;
DECLARE @last_start_year  INT = 2020;
DECLARE @last_end_year    INT = 2025;

-- Country mapping table (ISO_A2 to ISO_A3)
IF OBJECT_ID('tempdb..#country_mapping', 'U') IS NOT NULL
    DROP TABLE #country_mapping;

SELECT DISTINCT
    d.country_code AS iso_a2,
    d.country AS country_name,
    w.country_iso_alpha3_code AS iso_a3
INTO #country_mapping
FROM dimensions_2025jul.dbo.country d
LEFT JOIN wos_2539.dbo.country w
    ON d.country_code = w.country_iso_alpha2_code;

CREATE INDEX ix_country_mapping ON #country_mapping (iso_a2);
CREATE INDEX ix_country_mapping_a3 ON #country_mapping (iso_a3);

-- Leiden Ranking Universities (Open Edition 2025)

IF OBJECT_ID('tempdb..#LR_Open_Unis', 'U') IS NOT NULL DROP TABLE #LR_Open_Unis;
IF OBJECT_ID('tempdb..#lr_unis', 'U') IS NOT NULL DROP TABLE #lr_unis;

SELECT
    university_ror_id    AS ror_id,
    university           AS university,
    country_code         AS country_code,
    latitude,
    longitude
INTO #LR_Open_Unis
FROM leiden_ranking_open_edition_2025.dbo.university;

CREATE INDEX ix_lr_open_unis ON #LR_Open_Unis (ror_id);

-- Normalized lookup
SELECT
    ror_id,
    university        AS lr_university_name,
    country_code      AS lr_country_code,
    latitude,
    longitude
INTO #lr_unis
FROM #LR_Open_Unis;

CREATE INDEX ix_lr_unis ON #lr_unis (ror_id);

-- ============================================
-- SECTION 2: FIRST PUBLICATION YEAR (2000-2010)
-- ============================================

-- First publication year by researcher
IF OBJECT_ID('tempdb..#first_pub_year', 'U') IS NOT NULL 
    DROP TABLE #first_pub_year;

SELECT
    pa.researcher_id,
    MIN(p.pub_year) AS first_pub_year
INTO #first_pub_year
FROM
    dimensions_2025jul.dbo.pub_author pa
    JOIN dimensions_2025jul.dbo.pub p
        ON pa.pub_id = p.pub_id
WHERE
    pa.researcher_id IS NOT NULL
    AND p.pub_year IS NOT NULL
GROUP BY
    pa.researcher_id
HAVING
    MIN(p.pub_year) BETWEEN @first_start_year AND @first_end_year;


CREATE INDEX ix_first_pub_year
    ON #first_pub_year (researcher_id, first_pub_year);


-- First year at Leiden Ranking universities (origin window)
IF OBJECT_ID('tempdb..#first_year_LR', 'U') IS NOT NULL 
    DROP TABLE #first_year_LR;

SELECT DISTINCT
    fp.researcher_id,
    fp.first_pub_year,
    o.ror_id,
    lr.lr_university_name           AS lr_university_name,
    o.organization_name             AS org_name_in_dimensions,
    cm.iso_a3                       AS country_code
INTO #first_year_LR
FROM
    #first_pub_year fp
    JOIN dimensions_2025jul.dbo.pub_author pa
        ON fp.researcher_id = pa.researcher_id
    JOIN dimensions_2025jul.dbo.pub p
        ON pa.pub_id = p.pub_id
       AND p.pub_year = fp.first_pub_year
    JOIN dimensions_2025jul.dbo.pub_author_affiliation paa
        ON pa.pub_id = paa.pub_id
       AND pa.author_seq = paa.author_seq
    JOIN dimensions_2025jul.dbo.pub_affiliation_organization pao
        ON paa.pub_id = pao.pub_id
       AND paa.affiliation_seq = pao.affiliation_seq
    JOIN dimensions_2025jul.dbo.organization o
        ON pao.grid_id = o.grid_id
    JOIN #lr_unis lr
        ON o.ror_id = lr.ror_id
    LEFT JOIN #country_mapping cm
        ON o.country_code = cm.iso_a2;

CREATE INDEX ix_first_year_lr
    ON #first_year_LR (ror_id, country_code, researcher_id);


-- ============================================
-- SECTION 3: LAST PUBLICATION YEAR (2020-2025)
-- ============================================

-- Last publication year by researcher (only for researchers observed in first window)
IF OBJECT_ID('tempdb..#last_pub_year', 'U') IS NOT NULL 
    DROP TABLE #last_pub_year;

SELECT
    pa.researcher_id,
    MAX(p.pub_year) AS last_pub_year
INTO #last_pub_year
FROM
    dimensions_2025jul.dbo.pub_author pa
    JOIN dimensions_2025jul.dbo.pub p
        ON pa.pub_id = p.pub_id
WHERE
    pa.researcher_id IN (
        SELECT DISTINCT researcher_id
        FROM #first_year_LR
    )
    AND p.pub_year BETWEEN @last_start_year AND @last_end_year
GROUP BY
    pa.researcher_id;

CREATE INDEX ix_last_pub_year
    ON #last_pub_year (researcher_id, last_pub_year);


-- Destination-window LR observations across all years (for returnee detection)
IF OBJECT_ID('tempdb..#dest_window_LR_all_years', 'U') IS NOT NULL
    DROP TABLE #dest_window_LR_all_years;

SELECT DISTINCT
    pa.researcher_id,
    p.pub_year,
    o.ror_id
INTO #dest_window_LR_all_years
FROM dimensions_2025jul.dbo.pub_author pa
JOIN dimensions_2025jul.dbo.pub p
    ON pa.pub_id = p.pub_id
JOIN dimensions_2025jul.dbo.pub_author_affiliation paa
    ON pa.pub_id = paa.pub_id
   AND pa.author_seq = paa.author_seq
JOIN dimensions_2025jul.dbo.pub_affiliation_organization pao
    ON paa.pub_id = pao.pub_id
   AND paa.affiliation_seq = pao.affiliation_seq
JOIN dimensions_2025jul.dbo.organization o
    ON pao.grid_id = o.grid_id
JOIN #LR_Open_Unis lr
    ON o.ror_id = lr.ror_id
WHERE
    p.pub_year BETWEEN @last_start_year AND @last_end_year
    AND pa.researcher_id IN (SELECT DISTINCT researcher_id FROM #last_pub_year);

CREATE INDEX ix_dest_window_LR_all_years
    ON #dest_window_LR_all_years (researcher_id, pub_year, ror_id);


-- Last year at Leiden Ranking universities (destination window)
IF OBJECT_ID('tempdb..#last_year_LR', 'U') IS NOT NULL 
    DROP TABLE #last_year_LR;

SELECT DISTINCT
    lp.researcher_id,
    lp.last_pub_year AS pub_year,
    o.ror_id,
    lr.lr_university_name           AS lr_university_name,
    o.organization_name             AS org_name_in_dimensions,
    cm.iso_a3                       AS country_code
INTO #last_year_LR
FROM
    #last_pub_year lp
    JOIN dimensions_2025jul.dbo.pub_author pa
        ON lp.researcher_id = pa.researcher_id
    JOIN dimensions_2025jul.dbo.pub p
        ON pa.pub_id = p.pub_id
       AND p.pub_year = lp.last_pub_year
    JOIN dimensions_2025jul.dbo.pub_author_affiliation paa
        ON pa.pub_id = paa.pub_id
       AND pa.author_seq = paa.author_seq
    JOIN dimensions_2025jul.dbo.pub_affiliation_organization pao
        ON paa.pub_id = pao.pub_id
       AND paa.affiliation_seq = pao.affiliation_seq
    JOIN dimensions_2025jul.dbo.organization o
        ON pao.grid_id = o.grid_id
    JOIN #lr_unis lr
        ON o.ror_id = lr.ror_id
    LEFT JOIN #country_mapping cm
        ON o.country_code = cm.iso_a2;

CREATE INDEX ix_last_year_lr
    ON #last_year_LR (researcher_id, ror_id, country_code);


-- ============================================
-- SECTION 4: ORIGIN RECORDS & BASIC CLASSIFICATIONS
-- ============================================

-- Build a single origin record per researcher (earliest observed origin in start window)
IF OBJECT_ID('tempdb..#origin_one', 'U') IS NOT NULL
    DROP TABLE #origin_one;

WITH origin_candidates AS (
    SELECT
        researcher_id,
        first_pub_year,
        country_code,
        ror_id,
        ROW_NUMBER() OVER (
            PARTITION BY researcher_id
            ORDER BY first_pub_year ASC, ror_id ASC, country_code ASC
        ) AS rn
    FROM #first_year_LR
    WHERE researcher_id IS NOT NULL
)
SELECT
    researcher_id,
    first_pub_year,
    country_code AS origin_country,
    ror_id      AS origin_ror_id
INTO #origin_one
FROM origin_candidates
WHERE rn = 1;

CREATE INDEX ix_origin_one ON #origin_one (researcher_id, origin_country);


-- Researcher status (world)  (1 row per researcher)
IF OBJECT_ID('tempdb..#researcher_status', 'U') IS NOT NULL
    DROP TABLE #researcher_status;

SELECT
    o.researcher_id,
    CASE
        WHEN ly.researcher_id IS NOT NULL THEN 'Observed at LR in destination window'
        WHEN lp.researcher_id IS NOT NULL THEN 'Active outside Leiden Ranking'
        ELSE 'No publications in analysis window'
    END AS researcher_status,
    o.origin_country,
    o.first_pub_year
INTO #researcher_status
FROM #origin_one o
LEFT JOIN (
    SELECT DISTINCT researcher_id
    FROM #last_year_LR
) ly
    ON o.researcher_id = ly.researcher_id
LEFT JOIN (
    SELECT DISTINCT researcher_id
    FROM #last_pub_year
) lp
    ON o.researcher_id = lp.researcher_id;

CREATE INDEX ix_researcher_status ON #researcher_status (origin_country, researcher_status);


-- ============================================
-- SECTION 5: International workforce movement
-- (Global and country-level status with countries > 5000 researchers)
-- ============================================

-- 5A.1 Global researcher status summary
SELECT
    researcher_status,
    COUNT(*) AS n_researchers,
    CAST(100.0 * COUNT(*) / SUM(COUNT(*)) OVER () AS DECIMAL(6,2)) AS pct_of_total
FROM #researcher_status
GROUP BY researcher_status
ORDER BY n_researchers DESC;




-- Build a table of researcher ↔ origin_country based on any first-window LR affiliation
IF OBJECT_ID('tempdb..#origin_researchers_any', 'U') IS NOT NULL
    DROP TABLE #origin_researchers_any;

SELECT DISTINCT
    fy.researcher_id,
    fy.country_code AS origin_country
INTO #origin_researchers_any
FROM #first_year_LR fy;

CREATE INDEX ix_origin_researchers_any ON #origin_researchers_any (origin_country, researcher_id);


-- Ensure #origin_totals exists (any-affiliation counts)
IF OBJECT_ID('tempdb..#origin_totals', 'U') IS NOT NULL
    DROP TABLE #origin_totals;

SELECT
    origin_country,
    COUNT(DISTINCT researcher_id) AS n_origin_total
INTO #origin_totals
FROM #origin_researchers_any
GROUP BY origin_country;

CREATE INDEX ix_origin_totals ON #origin_totals (origin_country);


-- Build country-level outcome table using the any-affiliation researcher set joined to researcher_status by researcher_id
IF OBJECT_ID('tempdb..#researcher_status_by_country_v2', 'U') IS NOT NULL
    DROP TABLE #researcher_status_by_country_v2;

SELECT
    ot.origin_country                                         AS country_code,
    cm.country_name                                           AS origin_country_name,

    ot.n_origin_total                                         AS total_researchers_at_origin,

    -- counts of researchers (from the any-affiliation set) by outcome
    SUM(CASE WHEN rs.researcher_status = 'Observed at LR in destination window' THEN 1 ELSE 0 END)
        AS n_observed_at_lr_destination_window,

    SUM(CASE WHEN rs.researcher_status = 'Active outside Leiden Ranking' THEN 1 ELSE 0 END)
        AS n_active_outside_leiden_ranking,

    SUM(CASE WHEN rs.researcher_status = 'No publications in analysis window' THEN 1 ELSE 0 END)
        AS n_no_publications_in_analysis_window,

    -- percentages relative to the any-affiliation denominator
    CAST(
        100.0 * SUM(CASE WHEN rs.researcher_status = 'Observed at LR in destination window' THEN 1 ELSE 0 END)
        / NULLIF(ot.n_origin_total, 0)
        AS DECIMAL(6,2)
    ) AS pct_observed_at_lr_destination_window,

    CAST(
        100.0 * SUM(CASE WHEN rs.researcher_status = 'Active outside Leiden Ranking' THEN 1 ELSE 0 END)
        / NULLIF(ot.n_origin_total, 0)
        AS DECIMAL(6,2)
    ) AS pct_active_outside_leiden_ranking,

    CAST(
        100.0 * SUM(CASE WHEN rs.researcher_status = 'No publications in analysis window' THEN 1 ELSE 0 END)
        / NULLIF(ot.n_origin_total, 0)
        AS DECIMAL(6,2)
    ) AS pct_no_publications_in_analysis_window

INTO #researcher_status_by_country_v2
FROM #origin_totals ot
LEFT JOIN #country_mapping cm
    ON ot.origin_country = cm.iso_a3
LEFT JOIN #origin_researchers_any orec
    ON orec.origin_country = ot.origin_country
LEFT JOIN #researcher_status rs
    ON rs.researcher_id = orec.researcher_id
GROUP BY
    ot.origin_country,
    cm.country_name,
    ot.n_origin_total;

CREATE INDEX ix_rs_by_country_v2 ON #researcher_status_by_country_v2 (country_code, total_researchers_at_origin);



-- Output only countries with > 5000 researchers 
SELECT *
FROM #researcher_status_by_country_v2
WHERE total_researchers_at_origin > 5000
ORDER BY total_researchers_at_origin DESC;


-- ============================================
-- SECTION 6: BACKWARD-LOOKING ANALYSIS 
-- (Destination <-- Origin; inbound flows)
-- ============================================

-- 6.1 Destination-window LR active researchers in each destination country
IF OBJECT_ID('tempdb..#destination_lr_active', 'U') IS NOT NULL
    DROP TABLE #destination_lr_active;

SELECT
    ly.country_code AS destination_country,
    COUNT(DISTINCT ly.researcher_id) AS n_destination_active
INTO #destination_lr_active
FROM
    #last_year_LR ly
GROUP BY
    ly.country_code;

CREATE INDEX ix_destination_lr_active
    ON #destination_lr_active (destination_country);


-- 6.2 Reverse country-to-country flows (destination to origin)
IF OBJECT_ID('tempdb..#backward_country_flows', 'U') IS NOT NULL
    DROP TABLE #backward_country_flows;

SELECT
    ly.country_code AS destination_country,
    fy.country_code AS origin_country,
    COUNT(DISTINCT fy.researcher_id) AS n_researchers
INTO #backward_country_flows
FROM
    #last_year_LR ly
    INNER JOIN #first_year_LR fy
        ON ly.researcher_id = fy.researcher_id
WHERE
    ly.country_code IS NOT NULL
    AND fy.country_code IS NOT NULL
GROUP BY
    ly.country_code,
    fy.country_code;

CREATE INDEX ix_backward_country_flows
    ON #backward_country_flows (destination_country, origin_country);


-- Build #country_flows_lr: origin -> destination counts (LR observed in destination window)
IF OBJECT_ID('tempdb..#country_flows_lr', 'U') IS NOT NULL
    DROP TABLE #country_flows_lr;

SELECT
    fy.country_code  AS origin_country,
    ly.country_code  AS destination_country,
    COUNT(DISTINCT fy.researcher_id) AS n_researchers
INTO #country_flows_lr
FROM
    #first_year_LR fy
    INNER JOIN #last_year_LR ly
        ON fy.researcher_id = ly.researcher_id
WHERE
    fy.country_code IS NOT NULL
    AND ly.country_code IS NOT NULL
GROUP BY
    fy.country_code,
    ly.country_code;

CREATE INDEX ix_country_flows_lr ON #country_flows_lr (origin_country, destination_country, n_researchers);


-- 6.3 Mobility matrix (destination perspective)
IF OBJECT_ID('tempdb..#backward_mobility_matrix', 'U') IS NOT NULL
    DROP TABLE #backward_mobility_matrix;

SELECT
    b.destination_country,
    dc.country_name AS destination_country_name,
    b.origin_country,
    oc.country_name AS origin_country_name,
    b.n_researchers,
    d.n_destination_active,
    CAST(100.0 * b.n_researchers / NULLIF(d.n_destination_active, 0) AS DECIMAL(6,2))
        AS pct_of_destination_active
INTO #backward_mobility_matrix
FROM
    #backward_country_flows b
    JOIN #destination_lr_active d
        ON b.destination_country = d.destination_country
    LEFT JOIN #country_mapping dc
        ON b.destination_country = dc.iso_a3
    LEFT JOIN #country_mapping oc
        ON b.origin_country = oc.iso_a3;


-- 6.4 Researcher-level classification (backward) and returnee detection
IF OBJECT_ID('tempdb..#backward_mobility', 'U') IS NOT NULL
    DROP TABLE #backward_mobility;

WITH dest_base AS (
    SELECT DISTINCT
        ly.researcher_id,
        ly.ror_id AS dest_ror_id,
        ly.lr_university_name AS dest_university,
        ly.country_code AS dest_country
    FROM #last_year_LR ly
)
SELECT
    d.researcher_id,
    d.dest_ror_id,
    d.dest_university,
    d.dest_country,
    CASE
        WHEN EXISTS (
            SELECT 1
            FROM #first_year_LR fy
            WHERE fy.researcher_id = d.researcher_id
              AND fy.ror_id = d.dest_ror_id
        ) THEN 'Insider'

        WHEN EXISTS (
            SELECT 1
            FROM #first_year_LR fy
            WHERE fy.researcher_id = d.researcher_id
              AND fy.country_code = d.dest_country
        )
        AND NOT EXISTS (
            SELECT 1
            FROM #first_year_LR fy
            WHERE fy.researcher_id = d.researcher_id
              AND fy.ror_id = d.dest_ror_id
        ) THEN 'Domestic outsider'

        ELSE 'Foreign outsider'
    END AS status,

    CASE
        WHEN EXISTS (
            SELECT 1
            FROM (
                SELECT
                    MIN(pub_year) AS dest_first_year,
                    MAX(pub_year) AS dest_last_year
                FROM #dest_window_LR_all_years
                WHERE researcher_id = d.researcher_id
                  AND ror_id = d.dest_ror_id
            ) AS oy
            CROSS APPLY (
                SELECT MIN(pub_year) AS nondest_first_year
                FROM #dest_window_LR_all_years
                WHERE researcher_id = d.researcher_id
                  AND ror_id <> d.dest_ror_id
            ) AS ny
            WHERE oy.dest_first_year IS NOT NULL
              AND ny.nondest_first_year IS NOT NULL
              AND oy.dest_first_year < ny.nondest_first_year
              AND oy.dest_last_year > ny.nondest_first_year
        ) THEN 1 ELSE 0
    END AS is_returnee

INTO #backward_mobility
FROM dest_base d;

CREATE INDEX ix_backward_mobility
    ON #backward_mobility (dest_country, dest_ror_id, status, researcher_id);


-- BACKWARD: University-level table for destination perspective with ROR
IF OBJECT_ID('tempdb..#backward_university_table', 'U') IS NOT NULL
    DROP TABLE #backward_university_table;

SELECT
    bm.dest_ror_id                                               AS university_ror_id,
    COALESCE(r.lr_university_name, bm.dest_university)           AS university_name,
    cm.iso_a3                                                    AS iso_a3_country_code,
    FORMAT(r.latitude, '0.###############', 'en-US')             AS latitude,
    FORMAT(r.longitude, '0.###############', 'en-US')            AS longitude,
    COUNT(DISTINCT bm.researcher_id)                             AS n_researchers,
    SUM(CASE WHEN bm.status = 'Insider' THEN 1 ELSE 0 END)       AS n_insiders,
    CAST(
        100.0 * SUM(CASE WHEN bm.status = 'Insider' THEN 1 ELSE 0 END)
        / NULLIF(COUNT(DISTINCT bm.researcher_id), 0)
        AS DECIMAL(6,2)
    ) AS pct_insiders
INTO #backward_university_table
FROM #backward_mobility bm
LEFT JOIN #lr_unis r
    ON bm.dest_ror_id = r.ror_id
LEFT JOIN #country_mapping cm
    ON r.lr_country_code = cm.iso_a2
GROUP BY
    bm.dest_ror_id,
    COALESCE(r.lr_university_name, bm.dest_university),
    cm.iso_a3,
    r.latitude,
    r.longitude;

CREATE INDEX ix_backward_university_table ON #backward_university_table (iso_a3_country_code, n_researchers);

SELECT
    university_ror_id,
    university_name,
    iso_a3_country_code,
    latitude,
    longitude,
    n_researchers,
    n_insiders,
    pct_insiders
FROM #backward_university_table
ORDER BY n_researchers DESC;



-- ============================================
-- SECTION 7: International mobility flows
-- ============================================

-- Define the 12 selected countries (ISO A3)
IF OBJECT_ID('tempdb..#selected_countries', 'U') IS NOT NULL
    DROP TABLE #selected_countries;

CREATE TABLE #selected_countries (country_code CHAR(3) PRIMARY KEY);

INSERT INTO #selected_countries (country_code) VALUES
('USA'), ('CHN'), ('IND'), ('GBR'), ('DEU'), ('EGY'), ('ESP'), ('ARE'),
('BRA'), ('RUS'), ('JPN'), ('KOR');


-- 7.1 Country-level summary for selected countries: share of insiders and share of returnees

SELECT
    sc.country_code,
    cm.country_name,
    COALESCE(dst.n_destination_active, 0) AS n_destination_active,

    CAST(100.0 * SUM(CASE WHEN bm.status = 'Insider' THEN 1 ELSE 0 END) / NULLIF(COUNT(DISTINCT bm.researcher_id),0) AS DECIMAL(6,2))
        AS pct_insiders,

    CAST(100.0 * SUM(CASE WHEN bm.is_returnee = 1 THEN 1 ELSE 0 END) / NULLIF(COUNT(DISTINCT bm.researcher_id),0) AS DECIMAL(6,2))
        AS pct_returnees

FROM #selected_countries sc
LEFT JOIN #country_mapping cm
    ON sc.country_code = cm.iso_a3
LEFT JOIN #destination_lr_active dst
    ON sc.country_code = dst.destination_country
LEFT JOIN #backward_mobility bm
    ON sc.country_code = bm.dest_country
GROUP BY
    sc.country_code,
    cm.country_name,
    dst.n_destination_active
ORDER BY
    n_destination_active DESC;


-- 7.2 Top 6 source countries of people who arrived (inbound) — for each selected destination country

;WITH inbound_ranked AS (
    SELECT
        b.destination_country        AS focal_country,
        b.origin_country             AS source_country,
        COALESCE(cm.country_name, b.origin_country) AS source_country_name,
        b.n_researchers,
        d.n_destination_active,
        ROW_NUMBER() OVER (
            PARTITION BY b.destination_country
            ORDER BY b.n_researchers DESC
        ) AS rn
    FROM #backward_mobility_matrix b
    LEFT JOIN #country_mapping cm
        ON b.origin_country = cm.iso_a3
    JOIN #destination_lr_active d
        ON b.destination_country = d.destination_country
    WHERE b.destination_country IN (SELECT country_code FROM #selected_countries)
)
SELECT
    ir.focal_country                      AS destination_country_code,
    cmf.country_name                      AS destination_country_name,
    ir.source_country                     AS origin_country_code,
    ir.source_country_name                AS origin_country_name,
    ir.n_researchers,
    ir.n_destination_active,
    CAST(100.0 * ir.n_researchers / NULLIF(ir.n_destination_active, 0) AS DECIMAL(6,2)) 
        AS pct_of_destination_total
FROM inbound_ranked ir
LEFT JOIN #country_mapping cmf
    ON ir.focal_country = cmf.iso_a3
WHERE ir.rn <= 6
ORDER BY ir.focal_country, ir.rn;


-- 7.3 Top 6 destination countries of people who left (outbound) — for each selected origin country


-- Rank outbound destinations per selected origin and compute % of origin total
;WITH outbound_ranked AS (
    SELECT
        cf.origin_country   AS focal_country,
        cf.destination_country AS dest_country,
        COALESCE(cm.country_name, cf.destination_country) AS dest_country_name,
        cf.n_researchers,
        ot.n_origin_total,
        ROW_NUMBER() OVER (
            PARTITION BY cf.origin_country
            ORDER BY cf.n_researchers DESC
        ) AS rn
    FROM #country_flows_lr cf
    LEFT JOIN #country_mapping cm
        ON cf.destination_country = cm.iso_a3
    LEFT JOIN #origin_totals ot
        ON cf.origin_country = ot.origin_country
    WHERE cf.origin_country IN (SELECT country_code FROM #selected_countries)
)
SELECT
    orr.focal_country                     AS origin_country_code,
    cmo.country_name                      AS origin_country_name,
    orr.dest_country                      AS destination_country_code,
    orr.dest_country_name                 AS destination_country_name,
    orr.n_researchers,
    orr.n_origin_total,
    CAST(100.0 * orr.n_researchers / NULLIF(orr.n_origin_total, 0) AS DECIMAL(6,2))
        AS pct_of_origin_total
FROM outbound_ranked orr
LEFT JOIN #country_mapping cmo
    ON orr.focal_country = cmo.iso_a3
WHERE orr.rn <= 6
ORDER BY orr.focal_country, orr.rn;


-- 7.4 Researcher-level forward mobility classification (forward_mobility)
IF OBJECT_ID('tempdb..#forward_mobility', 'U') IS NOT NULL
    DROP TABLE #forward_mobility;

WITH origin_base AS (
    SELECT DISTINCT
        fy.researcher_id,
        fy.ror_id AS origin_ror_id,
        fy.lr_university_name AS origin_university,
        fy.country_code AS origin_country
    FROM #first_year_LR fy
),
returnee_base AS (
    -- Returnee within destination window (LR-observed):
    SELECT
        o.researcher_id,
        o.origin_ror_id,
        CASE
            WHEN oy.origin_first_year IS NOT NULL
             AND ny.nonorigin_first_year IS NOT NULL
             AND oy.origin_last_year IS NOT NULL
             AND oy.origin_first_year < ny.nonorigin_first_year
             AND oy.origin_last_year  > ny.nonorigin_first_year
            THEN 1 ELSE 0
        END AS is_returnee
    FROM origin_base o
    OUTER APPLY (
        SELECT
            MIN(pub_year) AS origin_first_year,
            MAX(pub_year) AS origin_last_year
        FROM #dest_window_LR_all_years
        WHERE researcher_id = o.researcher_id
          AND ror_id = o.origin_ror_id
    ) oy
    OUTER APPLY (
        SELECT
            MIN(pub_year) AS nonorigin_first_year
        FROM #dest_window_LR_all_years
        WHERE researcher_id = o.researcher_id
          AND ror_id <> o.origin_ror_id
    ) ny
)
SELECT
    o.researcher_id,
    o.origin_ror_id,
    o.origin_university,
    o.origin_country,
    CASE
        WHEN EXISTS (
            SELECT 1
            FROM #last_year_LR ly
            WHERE ly.researcher_id = o.researcher_id
              AND ly.ror_id = o.origin_ror_id
        ) THEN 'Insider'

        WHEN EXISTS (
            SELECT 1
            FROM #last_year_LR ly
            WHERE ly.researcher_id = o.researcher_id
              AND ly.country_code = o.origin_country
        )
        AND NOT EXISTS (
            SELECT 1
            FROM #last_year_LR ly
            WHERE ly.researcher_id = o.researcher_id
              AND ly.ror_id = o.origin_ror_id
        ) THEN 'Domestic outsider'

        WHEN EXISTS (
            SELECT 1
            FROM #last_year_LR ly
            WHERE ly.researcher_id = o.researcher_id
        ) THEN 'Foreign outsider'

        WHEN EXISTS (
            SELECT 1
            FROM #last_pub_year lp
            WHERE lp.researcher_id = o.researcher_id
        ) THEN 'Outside LR / missing affiliation'

        ELSE 'No publications in analysis window'
    END AS status,
    ISNULL(rb.is_returnee, 0) AS is_returnee
INTO #forward_mobility
FROM origin_base o
LEFT JOIN returnee_base rb
    ON o.researcher_id = rb.researcher_id
   AND o.origin_ror_id = rb.origin_ror_id;

CREATE INDEX ix_forward_mobility
    ON #forward_mobility (origin_country, origin_ror_id, status, researcher_id);


-- FORWARD: University-level table for origin (forward-looking) perspective with ROR

IF OBJECT_ID('tempdb..#forward_university_table', 'U') IS NOT NULL
    DROP TABLE #forward_university_table;

SELECT
    fm.origin_ror_id                                              AS university_ror_id,
    COALESCE(r.lr_university_name, fm.origin_university)          AS university_name,
    COALESCE(fm.origin_country, cm.iso_a3)                        AS iso_a3_country_code,
    FORMAT(r.latitude, '0.###############', 'en-US')             AS latitude,
    FORMAT(r.longitude, '0.###############', 'en-US')            AS longitude,
    COUNT(DISTINCT fm.researcher_id)                             AS n_researchers,
    SUM(CASE WHEN fm.status = 'Insider' THEN 1 ELSE 0 END)       AS n_insiders,
    CAST(
        100.0 * SUM(CASE WHEN fm.status = 'Insider' THEN 1 ELSE 0 END)
        / NULLIF(COUNT(DISTINCT fm.researcher_id), 0)
        AS DECIMAL(6,2)
    ) AS pct_insiders
INTO #forward_university_table
FROM #forward_mobility fm
LEFT JOIN #lr_unis r
    ON fm.origin_ror_id = r.ror_id
LEFT JOIN #country_mapping cm
    ON r.lr_country_code = cm.iso_a2
GROUP BY
    fm.origin_ror_id,
    COALESCE(r.lr_university_name, fm.origin_university),
    COALESCE(fm.origin_country, cm.iso_a3),
    r.latitude,
    r.longitude;

CREATE INDEX ix_forward_university_table ON #forward_university_table (iso_a3_country_code, n_researchers);

SELECT
    university_ror_id,
    university_name,
    iso_a3_country_code,
    latitude,
    longitude,
    n_researchers,
    n_insiders,
    pct_insiders
FROM #forward_university_table
ORDER BY n_researchers DESC;

-- 7.5 Forward-looking origin outcomes for selected countries

;WITH outbound_ranked AS (
    SELECT
        cf.origin_country   AS focal_country,
        cf.destination_country AS dest_country,
        COALESCE(cm.country_name, cf.destination_country) AS dest_country_name,
        cf.n_researchers,
        ot.n_origin_total,
        ROW_NUMBER() OVER (
            PARTITION BY cf.origin_country
            ORDER BY cf.n_researchers DESC
        ) AS rn
    FROM #country_flows_lr cf
    LEFT JOIN #country_mapping cm
        ON cf.destination_country = cm.iso_a3
    LEFT JOIN #origin_totals ot
        ON cf.origin_country = ot.origin_country
    WHERE cf.origin_country IN (SELECT country_code FROM #selected_countries)
)

/* Destination rows (rn 1..6) */
, dest_rows AS (
    SELECT
        orr.focal_country                     AS origin_country_code,
        cmo.country_name                      AS origin_country_name,
        orr.dest_country                      AS destination_country_code,
        orr.dest_country_name                 AS destination_country_name,
        orr.n_researchers,
        orr.n_origin_total,
        CAST(100.0 * orr.n_researchers / NULLIF(orr.n_origin_total, 0) AS DECIMAL(6,2))
            AS pct_of_origin_total,
        orr.rn                                AS display_order
    FROM outbound_ranked orr
    LEFT JOIN #country_mapping cmo
        ON orr.focal_country = cmo.iso_a3
    WHERE orr.rn <= 6
)

/* Status rows (two per origin): Active outside LR; No publications */
, status_rows AS (
    SELECT
        fm.origin_country                       AS origin_country_code,
        cm_orig.country_name                    AS origin_country_name,
        NULL                                    AS destination_country_code,
        fm.status AS status_label,
        COUNT(DISTINCT fm.researcher_id)        AS n_researchers,
        ot.n_origin_total,
        CAST(100.0 * COUNT(DISTINCT fm.researcher_id) / NULLIF(ot.n_origin_total,0) AS DECIMAL(6,2))
            AS pct_of_origin_total,
        CASE
            WHEN fm.status = 'Outside LR / missing affiliation' THEN 99
            WHEN fm.status = 'No publications in analysis window' THEN 100
            ELSE 101
        END AS display_order
    FROM #forward_mobility fm
    LEFT JOIN #origin_totals ot
        ON fm.origin_country = ot.origin_country
    LEFT JOIN #country_mapping cm_orig
        ON fm.origin_country = cm_orig.iso_a3
    WHERE fm.origin_country IN (SELECT country_code FROM #selected_countries)
      AND fm.status IN ('Outside LR / missing affiliation', 'No publications in analysis window')
    GROUP BY fm.origin_country, fm.status, ot.n_origin_total, cm_orig.country_name
)

/* Normalize status_rows columns to match dest_rows schema and union them */
SELECT
    dr.origin_country_code,
    dr.origin_country_name,
    dr.destination_country_code,
    dr.destination_country_name,
    dr.n_researchers,
    dr.n_origin_total,
    dr.pct_of_origin_total,
    dr.display_order
FROM dest_rows dr

UNION ALL

SELECT
    sr.origin_country_code,
    sr.origin_country_name,
    sr.destination_country_code,
    CASE 
        WHEN sr.status_label = 'Outside LR / missing affiliation' THEN 'Active outside Leiden Ranking'
        WHEN sr.status_label = 'No publications in analysis window' THEN 'No publications in analysis window'
        ELSE sr.status_label
    END AS destination_country_name,
    sr.n_researchers,
    sr.n_origin_total,
    sr.pct_of_origin_total,
    sr.display_order
FROM status_rows sr

ORDER BY origin_country_name, display_order, destination_country_name;

-- End of script



