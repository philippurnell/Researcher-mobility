
-- ============================================
-- SECTION 1: SETUP & CONFIGURATION
-- ============================================

-- Parameters (edit here to change time frame)
DECLARE @first_start_year INT = 2000;
DECLARE @first_end_year   INT = 2010;
DECLARE @last_start_year  INT = 2020;
DECLARE @last_end_year    INT = 2025;


-- Country mapping table (ISO_A2 to ISO_A3)
IF OBJECT_ID('tempdb..#country_mapping', 'U') IS NOT NULL
    DROP TABLE #country_mapping;

SELECT DISTINCT
    d.country_code AS iso_a2,
    d.country AS country_name,
    w.country_iso_alpha3_code AS iso_a3
INTO #country_mapping
FROM dimensions_2025jul.dbo.country d
LEFT JOIN wos_2539.dbo.country w
    ON d.country_code = w.country_iso_alpha2_code;

CREATE INDEX ix_country_mapping ON #country_mapping (iso_a2);
CREATE INDEX ix_country_mapping_a3 ON #country_mapping (iso_a3);


-- Leiden Ranking Universities (Open Edition 2025)
IF OBJECT_ID('tempdb..#LR_Open_Unis', 'U') IS NOT NULL 
    DROP TABLE #LR_Open_Unis;

SELECT
    university_ror_id, 
    university
INTO #LR_Open_Unis
FROM leiden_ranking_open_edition_2025..university;

CREATE INDEX ix_lr_open_unis ON #LR_Open_Unis (university_ror_id);


-- ============================================
-- SECTION 2: FIRST PUBLICATION YEAR (2000-2010)
-- ============================================

-- First publication year by researcher
IF OBJECT_ID('tempdb..#first_pub_year', 'U') IS NOT NULL 
    DROP TABLE #first_pub_year;

SELECT
    pa.researcher_id,
    MIN(p.pub_year) AS first_pub_year
INTO #first_pub_year
FROM
    dimensions_2025jul.dbo.pub_author pa
    JOIN dimensions_2025jul.dbo.pub p
        ON pa.pub_id = p.pub_id
WHERE
    pa.researcher_id IS NOT NULL
    AND p.pub_year IS NOT NULL
GROUP BY
    pa.researcher_id
HAVING
    MIN(p.pub_year) BETWEEN @first_start_year AND @first_end_year;


CREATE INDEX ix_first_pub_year
    ON #first_pub_year (researcher_id, first_pub_year);


-- First year at Leiden Ranking universities
IF OBJECT_ID('tempdb..#first_year_LR', 'U') IS NOT NULL 
    DROP TABLE #first_year_LR;

SELECT DISTINCT
    fp.researcher_id,
    fp.first_pub_year,
    o.ror_id,
    lr.university           AS lr_university_name,
    o.organization_name     AS org_name_in_dimensions,
    cm.iso_a3              AS country_code
INTO #first_year_LR
FROM
    #first_pub_year fp
    JOIN dimensions_2025jul.dbo.pub_author pa
        ON fp.researcher_id = pa.researcher_id
    JOIN dimensions_2025jul.dbo.pub p
        ON pa.pub_id = p.pub_id
       AND p.pub_year = fp.first_pub_year
    JOIN dimensions_2025jul.dbo.pub_author_affiliation paa
        ON pa.pub_id = paa.pub_id
       AND pa.author_seq = paa.author_seq
    JOIN dimensions_2025jul.dbo.pub_affiliation_organization pao
        ON paa.pub_id = pao.pub_id
       AND paa.affiliation_seq = pao.affiliation_seq
    JOIN dimensions_2025jul.dbo.organization o
        ON pao.grid_id = o.grid_id
    JOIN #LR_Open_Unis lr
        ON o.ror_id = lr.university_ror_id
    LEFT JOIN #country_mapping cm
        ON o.country_code = cm.iso_a2;

CREATE INDEX ix_first_year_lr
    ON #first_year_LR (ror_id, country_code, researcher_id);


-- First year university counts
IF OBJECT_ID('tempdb..#first_paper_university_counts', 'U') IS NOT NULL
    DROP TABLE #first_paper_university_counts;

SELECT
    fyl.ror_id,
    fyl.lr_university_name AS university,
    COUNT(DISTINCT fyl.researcher_id) AS n_researchers_first_paper
INTO #first_paper_university_counts
FROM
    #first_year_LR fyl
GROUP BY
    fyl.ror_id,
    fyl.lr_university_name;

SELECT
    ror_id,
    university,
    n_researchers_first_paper
FROM
    #first_paper_university_counts
ORDER BY
    n_researchers_first_paper DESC;


-- First year country counts
IF OBJECT_ID('tempdb..#first_paper_country_counts', 'U') IS NOT NULL
    DROP TABLE #first_paper_country_counts;

SELECT
    fyl.country_code,
    cm.country_name,
    COUNT(DISTINCT fyl.researcher_id) AS n_researchers_first_paper
INTO #first_paper_country_counts
FROM
    #first_year_LR fyl
    LEFT JOIN #country_mapping cm
        ON fyl.country_code = cm.iso_a3
GROUP BY
    fyl.country_code,
    cm.country_name;

SELECT
    country_code,
    country_name,
    n_researchers_first_paper
FROM
    #first_paper_country_counts
ORDER BY
    n_researchers_first_paper DESC;


-- ============================================
-- SECTION 3: LAST PUBLICATION YEAR (2020-2025)
-- ============================================

-- Last publication year by researcher
IF OBJECT_ID('tempdb..#last_pub_year', 'U') IS NOT NULL 
    DROP TABLE #last_pub_year;

SELECT
    pa.researcher_id,
    MAX(p.pub_year) AS last_pub_year
INTO #last_pub_year
FROM
    dimensions_2025jul.dbo.pub_author pa
    JOIN dimensions_2025jul.dbo.pub p
        ON pa.pub_id = p.pub_id
WHERE
    pa.researcher_id IN (
        SELECT DISTINCT researcher_id
        FROM #first_year_LR
    )
    AND p.pub_year BETWEEN @last_start_year AND @last_end_year
GROUP BY
    pa.researcher_id;

CREATE INDEX ix_last_pub_year
    ON #last_pub_year (researcher_id, last_pub_year);


-- Destination-window LR observations across ALL YEARS (for returnee flag)
IF OBJECT_ID('tempdb..#dest_window_LR_all_years', 'U') IS NOT NULL
    DROP TABLE #dest_window_LR_all_years;

SELECT DISTINCT
    pa.researcher_id,
    p.pub_year,
    o.ror_id
INTO #dest_window_LR_all_years
FROM dimensions_2025jul.dbo.pub_author pa
JOIN dimensions_2025jul.dbo.pub p
    ON pa.pub_id = p.pub_id
JOIN dimensions_2025jul.dbo.pub_author_affiliation paa
    ON pa.pub_id = paa.pub_id
   AND pa.author_seq = paa.author_seq
JOIN dimensions_2025jul.dbo.pub_affiliation_organization pao
    ON paa.pub_id = pao.pub_id
   AND paa.affiliation_seq = pao.affiliation_seq
JOIN dimensions_2025jul.dbo.organization o
    ON pao.grid_id = o.grid_id
JOIN #LR_Open_Unis lr
    ON o.ror_id = lr.university_ror_id
WHERE
    p.pub_year BETWEEN @last_start_year AND @last_end_year
    AND pa.researcher_id IN (SELECT DISTINCT researcher_id FROM #last_pub_year);

CREATE INDEX ix_dest_window_LR_all_years
    ON #dest_window_LR_all_years (researcher_id, pub_year, ror_id);


-- Last year at Leiden Ranking universities
IF OBJECT_ID('tempdb..#last_year_LR', 'U') IS NOT NULL 
    DROP TABLE #last_year_LR;

SELECT DISTINCT
    lp.researcher_id,
    lp.last_pub_year AS pub_year,
    o.ror_id,
    lr.university           AS lr_university_name,
    o.organization_name     AS org_name_in_dimensions,
    cm.iso_a3              AS country_code
INTO #last_year_LR
FROM
    #last_pub_year lp
    JOIN dimensions_2025jul.dbo.pub_author pa
        ON lp.researcher_id = pa.researcher_id
    JOIN dimensions_2025jul.dbo.pub p
        ON pa.pub_id = p.pub_id
       AND p.pub_year = lp.last_pub_year
    JOIN dimensions_2025jul.dbo.pub_author_affiliation paa
        ON pa.pub_id = paa.pub_id
       AND pa.author_seq = paa.author_seq
    JOIN dimensions_2025jul.dbo.pub_affiliation_organization pao
        ON paa.pub_id = pao.pub_id
       AND paa.affiliation_seq = pao.affiliation_seq
    JOIN dimensions_2025jul.dbo.organization o
        ON pao.grid_id = o.grid_id
    JOIN #LR_Open_Unis lr
        ON o.ror_id = lr.university_ror_id
    LEFT JOIN #country_mapping cm
        ON o.country_code = cm.iso_a2;

CREATE INDEX ix_last_year_lr
    ON #last_year_LR (researcher_id, ror_id, country_code);


-- Last year university counts
IF OBJECT_ID('tempdb..#last_paper_university_counts', 'U') IS NOT NULL
    DROP TABLE #last_paper_university_counts;

SELECT
    ror_id,
    lr_university_name AS university,
    COUNT(DISTINCT researcher_id) AS n_researchers_last_paper
INTO #last_paper_university_counts
FROM
    #last_year_LR
GROUP BY
    ror_id,
    lr_university_name;

SELECT
    ror_id,
    university,
    n_researchers_last_paper
FROM
    #last_paper_university_counts
ORDER BY
    n_researchers_last_paper DESC;


-- Last year country counts
IF OBJECT_ID('tempdb..#last_paper_country_counts', 'U') IS NOT NULL
    DROP TABLE #last_paper_country_counts;

SELECT
    lyl.country_code,
    cm.country_name,
    COUNT(DISTINCT lyl.researcher_id) AS n_researchers_last_paper
INTO #last_paper_country_counts
FROM
    #last_year_LR lyl
    LEFT JOIN #country_mapping cm
        ON lyl.country_code = cm.iso_a3
GROUP BY
    lyl.country_code,
    cm.country_name;

SELECT
    country_code,
    country_name,
    n_researchers_last_paper
FROM
    #last_paper_country_counts
ORDER BY
    n_researchers_last_paper DESC;

-- ============================================
-- SECTION 4: RESEARCHER STATUS CLASSIFICATION
-- ============================================

4.0 Build a single origin record per researcher
   - Choose earliest observed origin year in start window
   - If ties (multiple orgs/countries in same year), pick one deterministically

IF OBJECT_ID('tempdb..#origin_one', 'U') IS NOT NULL
    DROP TABLE #origin_one;

WITH origin_candidates AS (
    SELECT
        researcher_id,
        first_pub_year,
        country_code,
        ror_id,
        ROW_NUMBER() OVER (
            PARTITION BY researcher_id
            ORDER BY first_pub_year ASC, ror_id ASC, country_code ASC
        ) AS rn
    FROM #first_year_LR
    WHERE researcher_id IS NOT NULL
)
SELECT
    researcher_id,
    first_pub_year,
    country_code AS origin_country,
    ror_id      AS origin_ror_id
INTO #origin_one
FROM origin_candidates
WHERE rn = 1;

CREATE INDEX ix_origin_one ON #origin_one (researcher_id, origin_country);


-- 4.1 Researcher status (World)  (1 row per researcher)
IF OBJECT_ID('tempdb..#researcher_status', 'U') IS NOT NULL
    DROP TABLE #researcher_status;

SELECT
    o.researcher_id,
    CASE
        WHEN ly.researcher_id IS NOT NULL THEN 'Observed at LR in destination window'
        WHEN lp.researcher_id IS NOT NULL THEN 'Active outside Leiden Ranking'
        ELSE 'No publications in analysis window'
    END AS researcher_status,
    o.origin_country,
    o.first_pub_year
INTO #researcher_status
FROM #origin_one o
LEFT JOIN (
    SELECT DISTINCT researcher_id
    FROM #last_year_LR
) ly
    ON o.researcher_id = ly.researcher_id
LEFT JOIN (
    SELECT DISTINCT researcher_id
    FROM #last_pub_year
) lp
    ON o.researcher_id = lp.researcher_id;

CREATE INDEX ix_researcher_status ON #researcher_status (origin_country, researcher_status);


-- World summary
SELECT
    researcher_status,
    COUNT(*) AS n_researchers,
    CAST(100.0 * COUNT(*) / SUM(COUNT(*)) OVER () AS DECIMAL(6,2)) AS pct_of_total
FROM #researcher_status
GROUP BY researcher_status
ORDER BY n_researchers DESC;


-- 4.2 Researcher status by country (counts + % of origin)
IF OBJECT_ID('tempdb..#researcher_status_by_country', 'U') IS NOT NULL
    DROP TABLE #researcher_status_by_country;

SELECT
    rs.origin_country AS country_code,
    cm.country_name  AS origin_country_name,

    COUNT(*) AS total_researchers_at_origin,

    SUM(CASE WHEN rs.researcher_status = 'Observed at LR in destination window' THEN 1 ELSE 0 END)
        AS n_observed_at_lr_destination_window,

    SUM(CASE WHEN rs.researcher_status = 'Active outside Leiden Ranking' THEN 1 ELSE 0 END)
        AS n_active_outside_leiden_ranking,

    SUM(CASE WHEN rs.researcher_status = 'No publications in analysis window' THEN 1 ELSE 0 END)
        AS n_no_publications_in_analysis_window,

    CAST(
        100.0 * SUM(CASE WHEN rs.researcher_status = 'Observed at LR in destination window' THEN 1 ELSE 0 END)
        / NULLIF(COUNT(*), 0)
        AS DECIMAL(6,2)
    ) AS pct_observed_at_lr_destination_window,

    CAST(
        100.0 * SUM(CASE WHEN rs.researcher_status = 'Active outside Leiden Ranking' THEN 1 ELSE 0 END)
        / NULLIF(COUNT(*), 0)
        AS DECIMAL(6,2)
    ) AS pct_active_outside_leiden_ranking,

    CAST(
        100.0 * SUM(CASE WHEN rs.researcher_status = 'No publications in analysis window' THEN 1 ELSE 0 END)
        / NULLIF(COUNT(*), 0)
        AS DECIMAL(6,2)
    ) AS pct_no_publications_in_analysis_window
INTO #researcher_status_by_country
FROM #researcher_status rs
LEFT JOIN #country_mapping cm
    ON rs.origin_country = cm.iso_a3
GROUP BY
    rs.origin_country,
    cm.country_name;

SELECT *
FROM #researcher_status_by_country
ORDER BY origin_country_name; -- or ORDER BY country_code


-- 4.3 Origin international researchers (unique researchers; origin -> destination country differs)
IF OBJECT_ID('tempdb..#origin_international_researchers', 'U') IS NOT NULL
    DROP TABLE #origin_international_researchers;

SELECT DISTINCT
    o.origin_country,
    o.researcher_id
INTO #origin_international_researchers
FROM #origin_one o
JOIN #last_year_LR ly
    ON o.researcher_id = ly.researcher_id
WHERE
    o.origin_country IS NOT NULL
    AND ly.country_code IS NOT NULL
    AND ly.country_code <> o.origin_country;

IF OBJECT_ID('tempdb..#origin_international_counts', 'U') IS NOT NULL
    DROP TABLE #origin_international_counts;

SELECT
    origin_country,
    COUNT(DISTINCT researcher_id) AS n_international_researchers
INTO #origin_international_counts
FROM #origin_international_researchers
GROUP BY origin_country;


-- 4.4 Destination and origin countries at individual level (unique researcher-level mapping)
IF OBJECT_ID('tempdb..#dest_origin_researchers', 'U') IS NOT NULL
    DROP TABLE #dest_origin_researchers;

SELECT DISTINCT
    ly.researcher_id,
    ly.country_code AS destination_country,
    o.origin_country
INTO #dest_origin_researchers
FROM #last_year_LR ly
JOIN #origin_one o
    ON ly.researcher_id = o.researcher_id
WHERE
    ly.country_code IS NOT NULL
    AND o.origin_country IS NOT NULL;


-- 4.5 Destination international researchers (destination has >=1 foreign origin)
IF OBJECT_ID('tempdb..#destination_international_researchers', 'U') IS NOT NULL
    DROP TABLE #destination_international_researchers;

SELECT DISTINCT
    destination_country,
    researcher_id
INTO #destination_international_researchers
FROM #dest_origin_researchers
WHERE origin_country <> destination_country;

IF OBJECT_ID('tempdb..#destination_international_counts', 'U') IS NOT NULL
    DROP TABLE #destination_international_counts;

SELECT
    destination_country,
    COUNT(DISTINCT researcher_id) AS n_international_origin_researchers
INTO #destination_international_counts
FROM #destination_international_researchers
GROUP BY destination_country;



-- ============================================
-- SECTION 5: FORWARD-LOOKING ANALYSIS
-- (Origin --> Destination)
-- ============================================

-- 5.1 Country-level flows
-- Count total Leiden Ranking active researchers by origin country
IF OBJECT_ID('tempdb..#origin_lr_active', 'U') IS NOT NULL
    DROP TABLE #origin_lr_active;

SELECT
    rs.origin_country,
    COUNT(*) AS n_origin_lr_active
INTO #origin_lr_active
FROM
    #researcher_status rs
WHERE
    rs.researcher_status = 'Observed at LR in destination window'
GROUP BY
    rs.origin_country;

CREATE INDEX ix_origin_lr_active
    ON #origin_lr_active (origin_country);

-- Country-to-country flows (origin to destination)
IF OBJECT_ID('tempdb..#country_flows_lr', 'U') IS NOT NULL
    DROP TABLE #country_flows_lr;

SELECT
    fy.country_code AS origin_country,
    ly.country_code AS destination_country,
    COUNT(DISTINCT fy.researcher_id) AS n_researchers
INTO #country_flows_lr
FROM
    #first_year_LR fy
    INNER JOIN #last_year_LR ly
        ON fy.researcher_id = ly.researcher_id
WHERE
    fy.country_code IS NOT NULL
    AND ly.country_code IS NOT NULL
GROUP BY
    fy.country_code,
    ly.country_code;

CREATE INDEX ix_country_flows_lr
    ON #country_flows_lr (origin_country, destination_country);


-- 5.2 Top destinations by origin
IF OBJECT_ID('tempdb..#ranked_destinations_lr', 'U') IS NOT NULL
    DROP TABLE #ranked_destinations_lr;

SELECT
    cf.origin_country,
    cf.destination_country,
    cf.n_researchers,
    DENSE_RANK() OVER (
        PARTITION BY cf.origin_country
        ORDER BY cf.n_researchers DESC
    ) AS destination_rank
INTO #ranked_destinations_lr
FROM
    #country_flows_lr cf;

SELECT
    r.origin_country,
    cm1.country_name AS origin_country_name,
    r.destination_country,
    cm2.country_name AS destination_country_name,
    r.n_researchers AS n_moved_to_destination,
	o.n_origin_lr_active AS n_origin_observed_at_lr_destination_window,

    CAST(100.0 * r.n_researchers / NULLIF(o.n_origin_lr_active, 0) AS DECIMAL(6,2))
        AS pct_of_lr_active_researchers
FROM
    #ranked_destinations_lr r
    JOIN #origin_lr_active o
        ON r.origin_country = o.origin_country
    LEFT JOIN #country_mapping cm1
        ON r.origin_country = cm1.iso_a3
    LEFT JOIN #country_mapping cm2
        ON r.destination_country = cm2.iso_a3
WHERE
    r.destination_rank <= 20
ORDER BY
    origin_country_name,
    r.destination_rank;


-- 5.3 Domestic retention
SELECT
    cf.origin_country,
    cm.country_name AS origin_country_name,
    cf.origin_country AS destination_country,
    cm2.country_name AS destination_country_name,
    cf.n_researchers AS n_domestic,
    o.n_origin_lr_active,
    CAST(100.0 * cf.n_researchers / NULLIF(o.n_origin_lr_active, 0) AS DECIMAL(6,2)) 
        AS pct_domestic_retention
FROM
    #country_flows_lr cf
    JOIN #origin_lr_active o
        ON cf.origin_country = o.origin_country
    LEFT JOIN #country_mapping cm
        ON cf.origin_country = cm.iso_a3
    LEFT JOIN #country_mapping cm2
        ON cf.destination_country = cm2.iso_a3
WHERE
    cf.origin_country = cf.destination_country
ORDER BY
    pct_domestic_retention DESC;


-- 5.4 Internationalization share
SELECT
    oic.origin_country,
    cm.country_name AS origin_country_name,
    oic.n_international_researchers,
    o.n_origin_lr_active,
    CAST(100.0 * oic.n_international_researchers / NULLIF(o.n_origin_lr_active, 0) AS DECIMAL(6,2))
        AS pct_internationalized
FROM
    #origin_international_counts oic
    JOIN #origin_lr_active o
        ON oic.origin_country = o.origin_country
    LEFT JOIN #country_mapping cm
        ON oic.origin_country = cm.iso_a3
ORDER BY
    pct_internationalized DESC;


-- 5.5 Domestic vs international ratio
SELECT
    d.origin_country,
    d.origin_country_name,
    d.pct_domestic_retention,
    i.pct_internationalized,
    CASE 
        WHEN i.pct_internationalized IS NULL OR i.pct_internationalized = 0 THEN NULL
        ELSE d.pct_domestic_retention / i.pct_internationalized
    END AS domestic_to_international_ratio
FROM
    (
        SELECT
            cf.origin_country,
            cm.country_name AS origin_country_name,
            CAST(100.0 * cf.n_researchers / NULLIF(o.n_origin_lr_active, 0) AS DECIMAL(6,2)) 
                AS pct_domestic_retention
        FROM
            #country_flows_lr cf
            JOIN #origin_lr_active o ON cf.origin_country = o.origin_country
            LEFT JOIN #country_mapping cm ON cf.origin_country = cm.iso_a3
        WHERE
            cf.origin_country = cf.destination_country
    ) d
    JOIN
    (
        SELECT
            oic.origin_country,
            CAST(100.0 * oic.n_international_researchers / NULLIF(o.n_origin_lr_active, 0) AS DECIMAL(6,2))
                AS pct_internationalized
        FROM
            #origin_international_counts oic
            JOIN #origin_lr_active o
                ON oic.origin_country = o.origin_country
    ) i ON d.origin_country = i.origin_country
ORDER BY
    domestic_to_international_ratio;


-- 5.6 Mobility matrix
SELECT
    cf.origin_country,
    origin_cm.country_name AS origin_country_name,
    cf.destination_country,
    dest_cm.country_name AS destination_country_name,
    cf.n_researchers,
    o.n_origin_lr_active,
    CAST(100.0 * cf.n_researchers / NULLIF(o.n_origin_lr_active, 0) AS DECIMAL(6,2))
        AS pct_of_lr_active
FROM
    #country_flows_lr cf
    JOIN #origin_lr_active o
        ON cf.origin_country = o.origin_country
    LEFT JOIN #country_mapping origin_cm
        ON cf.origin_country = origin_cm.iso_a3
    LEFT JOIN #country_mapping dest_cm
        ON cf.destination_country = dest_cm.iso_a3
ORDER BY
    origin_country_name,
    pct_of_lr_active DESC;


-- 5.7 Researcher-level classification (forward, EXISTS-based)
-- Unit: (researcher_id, origin_ror_id)

IF OBJECT_ID('tempdb..#forward_mobility', 'U') IS NOT NULL
    DROP TABLE #forward_mobility;

WITH origin_base AS (
    SELECT DISTINCT
        fy.researcher_id,
        fy.ror_id AS origin_ror_id,
        fy.lr_university_name AS origin_university,
        fy.country_code AS origin_country
    FROM #first_year_LR fy
),
returnee_base AS (
    -- Returnee within destination window (LR-observed):
    -- origin observed before a non-origin year, and origin observed again after that year
    SELECT
        o.researcher_id,
        o.origin_ror_id,
        CASE
            WHEN oy.origin_first_year IS NOT NULL
             AND ny.nonorigin_first_year IS NOT NULL
             AND oy.origin_last_year IS NOT NULL
             AND oy.origin_first_year < ny.nonorigin_first_year
             AND oy.origin_last_year  > ny.nonorigin_first_year
            THEN 1 ELSE 0
        END AS is_returnee
    FROM origin_base o
    OUTER APPLY (
        SELECT
            MIN(pub_year) AS origin_first_year,
            MAX(pub_year) AS origin_last_year
        FROM #dest_window_LR_all_years
        WHERE researcher_id = o.researcher_id
          AND ror_id = o.origin_ror_id
    ) oy
    OUTER APPLY (
        SELECT
            MIN(pub_year) AS nonorigin_first_year
        FROM #dest_window_LR_all_years
        WHERE researcher_id = o.researcher_id
          AND ror_id <> o.origin_ror_id
    ) ny
)
SELECT
    o.researcher_id,
    o.origin_ror_id,
    o.origin_university,
    o.origin_country,
    CASE
        WHEN EXISTS (
            SELECT 1
            FROM #last_year_LR ly
            WHERE ly.researcher_id = o.researcher_id
              AND ly.ror_id = o.origin_ror_id
        ) THEN 'Insider'

        WHEN EXISTS (
            SELECT 1
            FROM #last_year_LR ly
            WHERE ly.researcher_id = o.researcher_id
              AND ly.country_code = o.origin_country
        )
        AND NOT EXISTS (
            SELECT 1
            FROM #last_year_LR ly
            WHERE ly.researcher_id = o.researcher_id
              AND ly.ror_id = o.origin_ror_id
        ) THEN 'Domestic outsider'

        -- Foreign outsider ONLY if observed at LR in destination endpoint (and not insider/domestic)
        WHEN EXISTS (
            SELECT 1
            FROM #last_year_LR ly
            WHERE ly.researcher_id = o.researcher_id
        ) THEN 'Foreign outsider'

        -- New 4th category: active in destination window (has pubs) but not observed at LR (or missing affiliation links)
        WHEN EXISTS (
            SELECT 1
            FROM #last_pub_year lp
            WHERE lp.researcher_id = o.researcher_id
        ) THEN 'Outside LR / missing affiliation'

        ELSE 'No publications in analysis window'
    END AS status,
    ISNULL(rb.is_returnee, 0) AS is_returnee
INTO #forward_mobility
FROM origin_base o
LEFT JOIN returnee_base rb
    ON o.researcher_id = rb.researcher_id
   AND o.origin_ror_id = rb.origin_ror_id;

CREATE INDEX ix_forward_mobility
    ON #forward_mobility (origin_country, origin_ror_id, status, researcher_id);



-- 5.8 University-level indicators (Forward, By Country, Unique Researchers)
-- Unit: unique researcher_id per origin country

IF OBJECT_ID('tempdb..#table1_forward_country', 'U') IS NOT NULL
    DROP TABLE #table1_forward_country;

SELECT
    fm.origin_country AS country_code,
    cm.country_name,
    COUNT(DISTINCT fm.researcher_id) AS n_researchers,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN fm.status = 'Insider' THEN fm.researcher_id END)
         / NULLIF(COUNT(DISTINCT fm.researcher_id), 0) AS DECIMAL(6,2)) AS pct_insiders,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN fm.status = 'Domestic outsider' THEN fm.researcher_id END)
         / NULLIF(COUNT(DISTINCT fm.researcher_id), 0) AS DECIMAL(6,2)) AS pct_domestic_outsiders,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN fm.status = 'Foreign outsider' THEN fm.researcher_id END)
         / NULLIF(COUNT(DISTINCT fm.researcher_id), 0) AS DECIMAL(6,2)) AS pct_foreign_outsiders,
	CAST(100.0 * COUNT(DISTINCT CASE WHEN fm.status = 'Outside LR / missing affiliation' THEN fm.researcher_id END)
     / NULLIF(COUNT(DISTINCT fm.researcher_id), 0) AS DECIMAL(6,2)) AS pct_outside_lr_or_missing,
	CAST(100.0 * COUNT(DISTINCT CASE WHEN fm.is_returnee = 1 THEN fm.researcher_id END)
     / NULLIF(COUNT(DISTINCT fm.researcher_id), 0) AS DECIMAL(6,2)) AS pct_returnees

INTO #table1_forward_country
FROM #forward_mobility fm
LEFT JOIN #country_mapping cm
    ON fm.origin_country = cm.iso_a3
GROUP BY
    fm.origin_country,
    cm.country_name;

SELECT *
FROM #table1_forward_country
ORDER BY n_researchers DESC;


-- 5.9: Table 1 (Forward, World, Unique Researchers) - WITH ABSOLUTE NUMBERS
SELECT
    'WORLD' AS geography,
    COUNT(DISTINCT researcher_id) AS n_researchers,
    COUNT(DISTINCT CASE WHEN status='Insider' THEN researcher_id END) AS n_insiders,
    COUNT(DISTINCT CASE WHEN status='Domestic outsider' THEN researcher_id END) AS n_domestic_outsiders,
    COUNT(DISTINCT CASE WHEN status='Foreign outsider' THEN researcher_id END) AS n_foreign_outsiders,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN status='Insider' THEN researcher_id END)
         / NULLIF(COUNT(DISTINCT researcher_id),0) AS DECIMAL(6,2)) AS pct_insiders,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN status='Domestic outsider' THEN researcher_id END)
         / NULLIF(COUNT(DISTINCT researcher_id),0) AS DECIMAL(6,2)) AS pct_domestic_outsiders,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN status='Foreign outsider' THEN researcher_id END)
         / NULLIF(COUNT(DISTINCT researcher_id),0) AS DECIMAL(6,2)) AS pct_foreign_outsiders,
	CAST(100.0 * COUNT(DISTINCT CASE WHEN fm.status = 'Outside LR / missing affiliation' THEN fm.researcher_id END)
     / NULLIF(COUNT(DISTINCT fm.researcher_id), 0) AS DECIMAL(6,2)) AS pct_outside_lr_or_missing,
	CAST(100.0 * COUNT(DISTINCT CASE WHEN fm.is_returnee = 1 THEN fm.researcher_id END)
     / NULLIF(COUNT(DISTINCT fm.researcher_id), 0) AS DECIMAL(6,2)) AS pct_returnees

FROM #forward_mobility fm;


-- ============================================
-- SECTION 6: BACKWARD-LOOKING ANALYSIS
-- (Destination --> Origin)
-- ============================================

-- 6.1 Country-level flows
-- Leiden Ranking-active researchers in each destination country
IF OBJECT_ID('tempdb..#destination_lr_active', 'U') IS NOT NULL
    DROP TABLE #destination_lr_active;

SELECT
    ly.country_code AS destination_country,
    COUNT(DISTINCT ly.researcher_id) AS n_destination_active
INTO #destination_lr_active
FROM
    #last_year_LR ly
GROUP BY
    ly.country_code;

CREATE INDEX ix_destination_lr_active
    ON #destination_lr_active (destination_country);

-- Reverse country-to-country flows (destination to origin)
IF OBJECT_ID('tempdb..#backward_country_flows', 'U') IS NOT NULL
    DROP TABLE #backward_country_flows;

SELECT
    ly.country_code AS destination_country,
    fy.country_code AS origin_country,
    COUNT(DISTINCT fy.researcher_id) AS n_researchers
INTO #backward_country_flows
FROM
    #last_year_LR ly
    INNER JOIN #first_year_LR fy
        ON ly.researcher_id = fy.researcher_id
WHERE
    ly.country_code IS NOT NULL
    AND fy.country_code IS NOT NULL
GROUP BY
    ly.country_code,
    fy.country_code;

CREATE INDEX ix_backward_country_flows
    ON #backward_country_flows (destination_country, origin_country);


-- 6.2 Domestic retention
SELECT
    b.destination_country,
    cm.country_name AS destination_country_name,
    b.origin_country AS origin_country,
    cm2.country_name AS origin_country_name,
    b.n_researchers AS n_domestic_origins,
    d.n_destination_active,
    CAST(100.0 * b.n_researchers / NULLIF(d.n_destination_active, 0) AS DECIMAL(6,2))
        AS pct_domestic_origins
FROM
    #backward_country_flows b
    JOIN #destination_lr_active d
        ON b.destination_country = d.destination_country
    LEFT JOIN #country_mapping cm
        ON b.destination_country = cm.iso_a3
    LEFT JOIN #country_mapping cm2
        ON b.origin_country = cm2.iso_a3
WHERE
    b.destination_country = b.origin_country
ORDER BY
    pct_domestic_origins DESC;


-- 6.3 Internationalization share
SELECT
    dic.destination_country,
    cm.country_name AS destination_country_name,
    dic.n_international_origin_researchers,
    d.n_destination_active,
    CAST(100.0 * dic.n_international_origin_researchers / NULLIF(d.n_destination_active, 0) AS DECIMAL(6,2))
        AS pct_international_origins
FROM
    #destination_international_counts dic
    JOIN #destination_lr_active d
        ON dic.destination_country = d.destination_country
    LEFT JOIN #country_mapping cm
        ON dic.destination_country = cm.iso_a3
ORDER BY
    pct_international_origins DESC;


-- 6.4 Domestic vs international ratio (SAFE: handles NULL + 0)
SELECT
    d.destination_country,
    d.destination_country_name,
    d.pct_domestic_origins,
    i.pct_international_origins,
    CASE
        WHEN i.pct_international_origins IS NULL OR i.pct_international_origins = 0 THEN NULL
        ELSE d.pct_domestic_origins / i.pct_international_origins
    END AS domestic_to_international_ratio
FROM
(
    -- Domestic origins: share of Leiden Ranking-active researchers whose origin country = destination country
    SELECT
        b.destination_country,
        cm.country_name AS destination_country_name,
        CAST(
            100.0 * b.n_researchers / NULLIF(da.n_destination_active, 0)
            AS DECIMAL(6,2)
        ) AS pct_domestic_origins
    FROM
        #backward_country_flows b
        JOIN #destination_lr_active da
            ON b.destination_country = da.destination_country
        LEFT JOIN #country_mapping cm
            ON b.destination_country = cm.iso_a3
    WHERE
        b.destination_country = b.origin_country
) d
LEFT JOIN
(
    -- International origins: share of lr-active researchers with â‰¥1 foreign origin
    SELECT
        dic.destination_country,
        CAST(
            100.0 * dic.n_international_origin_researchers / NULLIF(da.n_destination_active, 0)
            AS DECIMAL(6,2)
        ) AS pct_international_origins
    FROM
        #destination_international_counts dic
        JOIN #destination_lr_active da
            ON dic.destination_country = da.destination_country
) i
    ON d.destination_country = i.destination_country
ORDER BY
    domestic_to_international_ratio;



-- 6.5 Mobility matrix
SELECT
    b.destination_country,
    dc.country_name AS destination_country_name,
    b.origin_country,
    oc.country_name AS origin_country_name,
    b.n_researchers,
    d.n_destination_active,
    CAST(100.0 * b.n_researchers / NULLIF(d.n_destination_active, 0) AS DECIMAL(6,2))
        AS pct_of_destination_active
FROM
    #backward_country_flows b
    JOIN #destination_lr_active d
        ON b.destination_country = d.destination_country
    LEFT JOIN #country_mapping dc
        ON b.destination_country = dc.iso_a3
    LEFT JOIN #country_mapping oc
        ON b.origin_country = oc.iso_a3
ORDER BY
    destination_country_name,
    pct_of_destination_active DESC;


-- 6.6 Researcher-level classification (backward, EXISTS-based)
-- Unit: (researcher_id, dest_ror_id)

IF OBJECT_ID('tempdb..#backward_mobility', 'U') IS NOT NULL
    DROP TABLE #backward_mobility;

-- base set = each (researcher, destination university) observed in last window
WITH dest_base AS (
    SELECT DISTINCT
        ly.researcher_id,
        ly.ror_id AS dest_ror_id,
        ly.lr_university_name AS dest_university,
        ly.country_code AS dest_country
    FROM #last_year_LR ly
)
SELECT
    d.researcher_id,
    d.dest_ror_id,
    d.dest_university,
    d.dest_country,
    CASE
        WHEN EXISTS (
            SELECT 1
            FROM #first_year_LR fy
            WHERE fy.researcher_id = d.researcher_id
              AND fy.ror_id = d.dest_ror_id
        ) THEN 'Insider'

        WHEN EXISTS (
            SELECT 1
            FROM #first_year_LR fy
            WHERE fy.researcher_id = d.researcher_id
              AND fy.country_code = d.dest_country
        )
        AND NOT EXISTS (
            SELECT 1
            FROM #first_year_LR fy
            WHERE fy.researcher_id = d.researcher_id
              AND fy.ror_id = d.dest_ror_id
        ) THEN 'Domestic outsider'

        ELSE 'Foreign outsider'
    END AS status
INTO #backward_mobility
FROM dest_base d;

CREATE INDEX ix_backward_mobility
    ON #backward_mobility (dest_country, dest_ror_id, status, researcher_id);


-- 6.7: Table 1 (Backward, by country, unique researchers)

IF OBJECT_ID('tempdb..#table1_backward_country', 'U') IS NOT NULL
    DROP TABLE #table1_backward_country;

SELECT
    bm.dest_country AS country_code,
    cm.country_name,
    COUNT(DISTINCT bm.researcher_id) AS n_researchers,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN bm.status = 'Insider' THEN bm.researcher_id END)
         / NULLIF(COUNT(DISTINCT bm.researcher_id), 0) AS DECIMAL(6,2)) AS pct_insiders,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN bm.status = 'Domestic outsider' THEN bm.researcher_id END)
         / NULLIF(COUNT(DISTINCT bm.researcher_id), 0) AS DECIMAL(6,2)) AS pct_domestic_outsiders,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN bm.status = 'Foreign outsider' THEN bm.researcher_id END)
         / NULLIF(COUNT(DISTINCT bm.researcher_id), 0) AS DECIMAL(6,2)) AS pct_foreign_outsiders
INTO #table1_backward_country
FROM #backward_mobility bm
LEFT JOIN #country_mapping cm
    ON bm.dest_country = cm.iso_a3
GROUP BY
    bm.dest_country,
    cm.country_name;

SELECT *
FROM #table1_backward_country
ORDER BY n_researchers DESC;


-- 6.8: Table 1 (Backward, World, Unique Researchers)

SELECT
    'WORLD' AS geography,
    COUNT(DISTINCT researcher_id) AS n_researchers,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN status='Insider' THEN researcher_id END)
         / NULLIF(COUNT(DISTINCT researcher_id),0) AS DECIMAL(6,2)) AS pct_insiders,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN status='Domestic outsider' THEN researcher_id END)
         / NULLIF(COUNT(DISTINCT researcher_id),0) AS DECIMAL(6,2)) AS pct_domestic_outsiders,
    CAST(100.0 * COUNT(DISTINCT CASE WHEN status='Foreign outsider' THEN researcher_id END)
         / NULLIF(COUNT(DISTINCT researcher_id),0) AS DECIMAL(6,2)) AS pct_foreign_outsiders
FROM #backward_mobility;



-- ============================================
-- SECTION 7: COMPARATIVE ANALYSIS (TABLE 1, COUNTRY)
-- ============================================

SELECT 
    b.country_name,
    b.n_researchers AS backward_n_researchers,
    f.n_researchers AS forward_n_researchers,
    b.pct_insiders         AS backward_pct_insiders,
    f.pct_insiders         AS forward_pct_insiders,
    b.pct_domestic_outsiders AS backward_pct_domestic,
    f.pct_domestic_outsiders AS forward_pct_domestic,
    b.pct_foreign_outsiders AS backward_pct_foreign,
    f.pct_foreign_outsiders AS forward_pct_foreign
FROM #table1_backward_country b
JOIN #table1_forward_country  f
    ON b.country_code = f.country_code
WHERE b.country_name = 'Spain';
